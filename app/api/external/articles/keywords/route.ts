/**
 * Keyword-Based Article Generation API
 * POST /api/external/articles/keywords - Generate articles for Search Console keywords
 */

import { NextRequest, NextResponse } from "next/server"
import { prisma } from "@/lib/prisma"
import {
  generateKeywordContent,
  generateKeywordContentBatch,
  type KeywordContentOptions,
} from "@/lib/ai-services"
import { uploadBase64Image } from "@/lib/storage"

// POST - Generate articles for keywords
export async function POST(request: NextRequest) {
  try {
    const body = await request.json()
    const {
      keywords,
      category,
      locale = "en",
      generateImages = true,
      imageStyle = "digital-art",
      tone = "educational",
      length = "medium",
      saveToDatabase = true,
      publishImmediately = false,
    } = body

    if (!keywords || !Array.isArray(keywords) || keywords.length === 0) {
      return NextResponse.json(
        { error: "Keywords array is required" },
        { status: 400 }
      )
    }

    // Limit batch size
    const maxKeywords = 10
    if (keywords.length > maxKeywords) {
      return NextResponse.json(
        { error: `Maximum ${maxKeywords} keywords allowed per batch` },
        { status: 400 }
      )
    }

    // Prepare keyword options
    const keywordOptions: KeywordContentOptions[] = keywords.map((kw: {
      keyword: string
      impressions?: number
      position?: number
    }) => ({
      keyword: typeof kw === "string" ? kw : kw.keyword,
      impressions: typeof kw === "object" ? kw.impressions : undefined,
      currentPosition: typeof kw === "object" ? kw.position : undefined,
      category,
      locale,
      generateImage: generateImages,
      imageStyle,
      tone,
      length,
    }))

    // Generate content for all keywords
    const result = await generateKeywordContentBatch(keywordOptions, 2000)

    // Save to database if requested
    const savedArticles: Array<{
      id: string
      slug: string
      keyword: string
      status: string
    }> = []

    if (saveToDatabase) {
      for (const item of result.results) {
        if (item.success && item.article) {
          try {
            // Check if slug already exists
            const existing = await prisma.article.findUnique({
              where: { slug: item.article.slug },
            })

            if (existing) {
              // Append timestamp to make unique
              item.article.slug = `${item.article.slug}-${Date.now()}`
            }

            // Upload cover image if present
            let coverImageUrl: string | undefined
            if (item.article.coverImage && item.article.coverImageMimeType) {
              try {
                coverImageUrl = await uploadBase64Image(
                  item.article.coverImage,
                  item.article.coverImageMimeType,
                  `articles/${item.article.slug}`
                )
              } catch (uploadError) {
                console.error("Failed to upload cover image:", uploadError)
              }
            }

            // Create article in database
            const article = await prisma.article.create({
              data: {
                slug: item.article.slug,
                title: item.article.title,
                content: item.article.content,
                excerpt: item.article.excerpt,
                coverImage: coverImageUrl,
                category: item.article.category,
                tags: item.article.tags,
                seoTitle: item.article.seoTitle,
                seoDescription: item.article.seoDescription,
                locale,
                status: publishImmediately ? "PUBLISHED" : "DRAFT",
                publishedAt: publishImmediately ? new Date() : null,
                isAutogenerated: true,
                sourceType: "search-console-keyword",
                sourceUrl: `keyword:${item.keyword}`,
              },
            })

            savedArticles.push({
              id: article.id,
              slug: article.slug,
              keyword: item.keyword,
              status: article.status,
            })
          } catch (dbError) {
            console.error(`Failed to save article for keyword "${item.keyword}":`, dbError)
          }
        }
      }
    }

    return NextResponse.json({
      success: result.success,
      generated: result.successCount,
      failed: result.failureCount,
      savedArticles,
      results: result.results.map((r) => ({
        keyword: r.keyword,
        success: r.success,
        title: r.article?.title,
        slug: r.article?.slug,
        error: r.error,
      })),
    })
  } catch (error) {
    console.error("Keyword content generation error:", error)
    return NextResponse.json(
      { error: "Failed to generate content for keywords" },
      { status: 500 }
    )
  }
}
