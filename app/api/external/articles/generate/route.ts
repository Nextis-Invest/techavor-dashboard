import { NextRequest, NextResponse } from "next/server"
import { prisma } from "@/lib/prisma"
import { validateApiKey, hasPermission, corsHeaders } from "@/lib/api-auth"
import { generateAutoblogArticle, generateBatchArticles } from "@/lib/ai-services"
import { uploadBase64Image } from "@/lib/storage"

export async function OPTIONS() {
  return NextResponse.json({}, { headers: corsHeaders() })
}

/**
 * POST /api/external/articles/generate
 * Generate a new article using AI (Nano Banana for images, Gemini for content)
 *
 * Body:
 *   - topic: string (required) - The topic to write about
 *   - keywords: string[] (optional) - Keywords to include
 *   - category: string (optional) - Article category
 *   - locale: string (optional) - Language locale (default: "en")
 *   - generateImage: boolean (optional) - Generate cover image (default: true)
 *   - imageStyle: string (optional) - Image style (photorealistic, digital-art, illustration, 3d-render)
 *   - tone: string (optional) - Writing tone (professional, casual, educational, technical)
 *   - length: string (optional) - Article length (short, medium, long)
 *   - autoPublish: boolean (optional) - Publish immediately (default: false)
 */
export async function POST(request: NextRequest) {
  const headers = corsHeaders(request.headers.get("origin") || undefined)

  // Validate API key
  const validation = await validateApiKey(request)

  if (!validation.isValid) {
    return NextResponse.json(
      { error: validation.error },
      { status: 401, headers }
    )
  }

  if (!hasPermission(validation.apiKey!.permissions, "write")) {
    return NextResponse.json(
      { error: "Missing required permission: write" },
      { status: 403, headers }
    )
  }

  try {
    const body = await request.json()
    const {
      topic,
      keywords,
      category,
      locale = "en",
      generateImage = true,
      imageStyle = "digital-art",
      tone = "professional",
      length = "medium",
      autoPublish = false,
    } = body

    // Validate required fields
    if (!topic) {
      return NextResponse.json(
        { error: "Topic is required" },
        { status: 400, headers }
      )
    }

    // Generate the article using AI
    const result = await generateAutoblogArticle({
      topic,
      keywords,
      category,
      locale,
      generateImage,
      imageStyle,
      tone,
      length,
    })

    if (!result.success || !result.article) {
      return NextResponse.json(
        { error: result.error || "Failed to generate article" },
        { status: 500, headers }
      )
    }

    // Upload cover image if generated
    let coverImageUrl: string | null = null
    if (result.article.coverImage) {
      try {
        const uploadResult = await uploadBase64Image(
          result.article.coverImage,
          result.article.coverImageMimeType || "image/png",
          `articles/${Date.now()}-cover`
        )
        if (uploadResult.success) {
          coverImageUrl = uploadResult.url
        }
      } catch (error) {
        console.error("Failed to upload cover image:", error)
        // Continue without cover image
      }
    }

    // Generate slug from title
    const slug = generateSlug(result.article.title)

    // Check if slug already exists
    const existingArticle = await prisma.article.findUnique({
      where: { slug },
    })

    const finalSlug = existingArticle
      ? `${slug}-${Date.now().toString(36)}`
      : slug

    // Calculate reading time
    const wordCount = result.article.content.split(/\s+/).length
    const readingTime = Math.max(1, Math.ceil(wordCount / 200))

    // Create the article in database
    const article = await prisma.article.create({
      data: {
        title: result.article.title,
        slug: finalSlug,
        excerpt: result.article.excerpt,
        content: result.article.content,
        coverImage: coverImageUrl,
        author: "Techavor AI",
        authorAvatar: null,
        category: result.article.category,
        tags: result.article.tags,
        status: autoPublish ? "PUBLISHED" : "DRAFT",
        publishedAt: autoPublish ? new Date() : null,
        locale,
        seoTitle: result.article.seoTitle,
        seoDescription: result.article.seoDescription,
        readingTime,
        isAutogenerated: true,
        sourceType: "ai-generated",
        sourceUrl: null,
      },
    })

    return NextResponse.json({
      success: true,
      article: {
        id: article.id,
        slug: article.slug,
        title: article.title,
        status: article.status,
        category: article.category,
        readingTime: article.readingTime,
        hasCoverImage: !!coverImageUrl,
        createdAt: article.createdAt.toISOString(),
      },
    }, { status: 201, headers })
  } catch (error) {
    console.error("Error generating article:", error)
    return NextResponse.json(
      { error: "Failed to generate article" },
      { status: 500, headers }
    )
  }
}

/**
 * Generate a URL-friendly slug from a title
 */
function generateSlug(title: string): string {
  return title
    .toLowerCase()
    .replace(/[^\w\s-]/g, "") // Remove special characters
    .replace(/\s+/g, "-") // Replace spaces with hyphens
    .replace(/--+/g, "-") // Replace multiple hyphens with single
    .replace(/^-+/, "") // Remove leading hyphens
    .replace(/-+$/, "") // Remove trailing hyphens
    .substring(0, 100) // Limit length
}
